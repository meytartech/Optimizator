{% extends "base.html" %}

{% block title %}Running Jobs{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/jobs.css') }}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Running Jobs</h1>
</div>

<div class="jobs-container">
    <!-- Filter buttons -->
    <div class="filter-buttons">
        <button class="btn btn-secondary active" data-filter="all">All</button>
        <button class="btn btn-secondary" data-filter="queued">Queued</button>
        <button class="btn btn-secondary" data-filter="running">Running</button>
        <button class="btn btn-secondary" data-filter="completed">Completed</button>
        <button class="btn btn-secondary" data-filter="failed">Failed</button>
    </div>

    <!-- Jobs list -->
    <div id="jobs-list" class="jobs-grid">
        <!-- Will be filled by JavaScript -->
        <div class="empty-state">
            <p>No jobs at the moment.</p>
        </div>
    </div>
</div>

<style>
.jobs-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
}

.filter-buttons {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
}

.filter-buttons .btn {
    padding: var(--space-sm) var(--space-md);
    font-size: 0.875rem;
}

.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-lg);
}

.job-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    transition: transform 0.2s, box-shadow 0.2s;
}

.job-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.job-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-md);
}

.job-title {
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
}

.job-type {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 4px 8px;
    border-radius: 4px;
    background: var(--bg-main);
    color: var(--primary);
}

.job-type.backtest {
    background: rgba(99, 102, 241, 0.1);
    color: #6366f1;
}

.job-type.optimization {
    background: rgba(139, 92, 246, 0.1);
    color: #8b5cf6;
}

.job-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-badge.queued {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

.status-badge.running {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

.status-badge.completed {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.status-badge.failed {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.status-badge.cancelled {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

.job-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    font-size: 0.875rem;
    color: var(--text-muted);
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.meta-label {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.meta-value {
    color: var(--text-primary);
}

.job-progress {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-main);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: right;
}

.job-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 6px;
    padding: var(--space-md);
    color: #ef4444;
    font-size: 0.875rem;
    word-break: break-word;
}

.job-actions {
    display: flex;
    gap: var(--space-sm);
}

.job-actions .btn {
    flex: 1;
    padding: 8px 12px;
    font-size: 0.875rem;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}

.empty-state p {
    font-size: 1.125rem;
}

/* Loading indicator */
.spinner {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid rgba(59, 130, 246, 0.2);
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
let allJobs = [];
let currentFilter = 'all';

// Load jobs on page load
async function loadJobs() {
    try {
        const response = await fetch('/api/jobs');
        allJobs = await response.json();
        renderJobs(currentFilter);
        
        // Auto-refresh every 2 seconds
        setTimeout(loadJobs, 2000);
    } catch (error) {
        console.error('Failed to load jobs:', error);
    }
}

function renderJobs(filter = 'all') {
    currentFilter = filter;
    const jobsList = document.getElementById('jobs-list');
    
    let filtered = allJobs;
    if (filter !== 'all') {
        filtered = allJobs.filter(job => job.status === filter);
    }
    
    if (filtered.length === 0) {
        jobsList.innerHTML = '<div class="empty-state"><p>No jobs at the moment.</p></div>';
        return;
    }
    
    jobsList.innerHTML = filtered.map(job => `
        <div class="job-card">
            <div class="job-header">
                <div class="job-title">${escapeHtml(job.strategy_name)}</div>
                <div class="job-type ${job.job_type}">${job.job_type.toUpperCase()}</div>
            </div>
            
            <div class="job-status">
                ${job.status === 'running' ? '<span class="spinner"></span>' : ''}
                <span class="status-badge ${job.status}">${formatStatus(job.status)}</span>
            </div>
            
            <div class="job-meta">
                <div class="meta-item">
                    <div class="meta-label">Status</div>
                    <div class="meta-value">${formatStatus(job.status)}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Created</div>
                    <div class="meta-value">${formatTimeShort(job.created_at)}</div>
                </div>
                ${job.started_at ? `
                <div class="meta-item">
                    <div class="meta-label">Started</div>
                    <div class="meta-value">${formatTimeShort(job.started_at)}</div>
                </div>
                ` : ''}
                ${job.completed_at && job.started_at ? `
                <div class="meta-item">
                    <div class="meta-label">Duration</div>
                    <div class="meta-value">${formatDuration(job.started_at, job.completed_at)}</div>
                </div>
                ` : ''}
            </div>
            
            ${job.status === 'running' ? `
            <div class="job-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${job.progress}%"></div>
                </div>
                <div class="progress-text">${job.progress}%</div>
            </div>
            ` : ''}
            
            ${job.error ? `
            <div class="job-error">
                <strong>Error:</strong> ${escapeHtml(job.error)}
            </div>
            ` : ''}
            
            <div class="job-actions">
                ${job.status === 'completed' && job.result_id ? `
                <a href="/results/${job.job_type}/${job.result_id}" class="btn btn-primary">View Results</a>
                ` : ''}
                ${job.status === 'queued' ? `
                <button class="btn btn-secondary" onclick="cancelJob('${job.job_id}')">Cancel</button>
                ` : ''}
                ${(job.status === 'completed' || job.status === 'failed') ? `
                <button class="btn btn-danger" onclick="deleteJob('${job.job_id}', '${escapeHtml(job.job_id)}')">Delete</button>
                ` : ''}
            </div>
        </div>
    `).join('');
    
    // Add filter button listeners
    document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
            btn.classList.add('active');
        }
    });
}

function formatStatus(status) {
    return status.charAt(0).toUpperCase() + status.slice(1);
}

function formatTime(isoStr) {
    const date = new Date(isoStr);
    return date.toLocaleString();
}

function formatTimeShort(isoStr) {
    const date = new Date(isoStr);
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days}d ago`;
    if (hours > 0) return `${hours}h ago`;
    if (minutes > 0) return `${minutes}m ago`;
    return `${seconds}s ago`;
}

function formatDuration(startIso, endIso) {
    const start = new Date(startIso);
    const end = new Date(endIso);
    const diff = end - start;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) return `${hours}h ${minutes % 60}m`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function cancelJob(jobId) {
    if (!confirm('Cancel this job?')) return;
    
    try {
        const response = await fetch(`/api/jobs/${jobId}/cancel`, { method: 'POST' });
        if (response.ok) {
            loadJobs();
        } else {
            alert('Failed to cancel job');
        }
    } catch (error) {
        console.error('Failed to cancel job:', error);
    }
}

async function deleteJob(jobId, jobIdDisplay) {
    if (!confirm(`Delete job ${jobIdDisplay}?\nThis action cannot be undone.`)) return;
    
    try {
        const response = await fetch(`/api/jobs/${jobId}`, { method: 'DELETE' });
        if (response.ok) {
            loadJobs();
        } else {
            const data = await response.json();
            alert(`Failed to delete job: ${data.error}`);
        }
    } catch (error) {
        console.error('Failed to delete job:', error);
        alert(`Error deleting job: ${error.message}`);
    }
}

// Filter button click handlers
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            renderJobs(this.dataset.filter);
        });
    });
    
    loadJobs();
});
</script>
{% endblock %}
