{% extends "base.html" %}

{% block title %}Backtest - Backtesting System{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/backtest.css') }}">
{% endblock %}

{% block content %}


<div class="backtest-form-container">
    <form id="backtestForm" class="backtest-form">
        <!-- STEP 1: Data & Strategy Section -->
        <div class="form-card accordion-card">
            <div class="card-header accordion-header" data-accordion="step-1">
                <div class="step-badge">1</div>
                <div class="accordion-title">
                    <h2 class="card-title">Data & Strategy</h2>
                    <p class="card-subtitle">Select your data file and trading strategy</p>
                </div>
                <div class="accordion-icon">⌄</div>
            </div>
            <div class="card-content accordion-content" id="step-1">
                <div class="form-row">
                    <div class="form-group">
                        <label for="dataFile" class="form-label-required">
                            <span>Data File</span>
                        </label>
                        <select id="dataFile" class="form-input form-select" required>
                            {% for file in data_files %}
                            <option value="{{ file }}">{{ file }}</option>
                            {% endfor %}
                        </select>
                        <span class="field-hint">Combined .db file with OHLC + multi-timeframe scores (1m, 5m, 15m, 60m)</span>
                    </div>
                    <div class="form-group">
                        <label for="strategy" class="form-label-required">
                            <span>Strategy</span>
                        </label>
                        <select id="strategy" class="form-input form-select" required>
                            {% for strategy in strategies %}
                            <option value="{{ strategy }}" {% if strategy == 'mnq_strategy' %}selected{% endif %}>{{ strategy }}</option>
                            {% endfor %}
                        </select>
                        <span class="field-hint">Choose which strategy to backtest</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: Capital & Costs Section -->
        <div class="form-card accordion-card">
            <div class="card-header accordion-header" data-accordion="step-2">
                <div class="step-badge">2</div>
                <div class="accordion-title">
                    <h2 class="card-title">Capital & Costs</h2>
                    <p class="card-subtitle">Configure trading capital and transaction costs</p>
                </div>
                <div class="accordion-icon">⌄</div>
            </div>
            <div class="card-content accordion-content" id="step-2">
                <div class="form-row">
                    <div class="form-group">
                        <label for="initialCapital" class="form-label-required">
                            <span>Initial Capital</span>
                            <span class="currency-badge">$</span>
                        </label>
                        <input type="number" id="initialCapital" class="form-input" value="50000" step="1000" required>
                        <span class="field-hint">Starting account balance in USD</span>
                    </div>
                    <div class="form-group">
                        <label for="commission" class="form-label">
                            <span>Commission per Trade</span>
                            <span class="currency-badge">$</span>
                        </label>
                        <input type="number" id="commission" class="form-input" value="0.5" step="0.1">
                        <span class="field-hint">Cost per trade execution</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="slippageTicks" class="form-label">
                            <span>Slippage</span>
                            <span class="unit-badge">ticks</span>
                        </label>
                        <input type="number" id="slippageTicks" class="form-input" value="0" step="1">
                        <span class="field-hint">Adverse price movement per trade</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="maxBarsBack" class="form-label">
                            <span>Max Bars Back</span>
                            <span class="unit-badge">bars</span>
                        </label>
                        <input type="number" id="maxBarsBack" class="form-input" value="100" min="0" step="10">
                        <span class="field-hint">Historical bars passed to strategy (0 = all)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 3: Instrument Specifications Section -->
        <div class="form-card accordion-card">
            <div class="card-header accordion-header" data-accordion="step-3">
                <div class="step-badge">3</div>
                <div class="accordion-title">
                    <h2 class="card-title">Instrument Specifications</h2>
                    <p class="card-subtitle">Define instrument properties for accurate P&L</p>
                </div>
                <div class="accordion-icon">⌄</div>
            </div>
            <div class="card-content accordion-content" id="step-3">
                <div class="form-row">
                    <div class="form-group">
                        <label for="instrumentType" class="form-label-required">
                            <span>Instrument Type</span>
                        </label>
                        <select id="instrumentType" class="form-input form-select" required>
                            <option value="stock">Stock (Dollar-based)</option>
                            <option value="futures" selected>Futures (Point-based)</option>
                        </select>
                        <span class="field-hint">Affects P&L calculation method</span>
                    </div>
                    <div class="form-group">
                        <label for="pointValue" class="form-label-required">
                            <span>Point Value</span>
                            <span class="currency-badge">$</span>
                        </label>
                        <input type="number" id="pointValue" class="form-input" value="2.0" step="0.1" required>
                        <span class="field-hint">$ earned per 1-point move (MNQ: 2.0, ES: 50)</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="tickSize" class="form-label-required">
                            <span>Tick Size</span>
                        </label>
                        <input type="number" id="tickSize" class="form-input" value="0.25" step="0.01" required>
                        <span class="field-hint">Minimum price increment (MNQ: 0.25, ES: 0.25)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Primary CTA and Feedback -->
        <div class="form-actions-sticky">
            <button type="submit" class="btn btn-primary btn-large btn-backtest-submit" id="submitBtn">
                <span class="btn-icon">⚡</span>
                <span class="btn-text">Run Backtest</span>
            </button>
        </div>
    </form>

    <!-- Status Messages -->
    <div id="resultMessage" class="message" style="display:none;"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ============= ACCORDION FUNCTIONALITY =============
function initializeAccordions() {
    const accordionHeaders = document.querySelectorAll('.accordion-header');
    
    // Collapse all except the first one
    accordionHeaders.forEach((header, index) => {
        const card = header.closest('.accordion-card');
        if (index !== 0) {
            card.classList.add('collapsed');
        }
    });
    
    // Add click handlers
    accordionHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const card = this.closest('.accordion-card');
            const isCollapsed = card.classList.contains('collapsed');
            
            // Close all other accordions
            document.querySelectorAll('.accordion-card').forEach(otherCard => {
                otherCard.classList.add('collapsed');
            });
            
            // Toggle current accordion
            if (isCollapsed) {
                card.classList.remove('collapsed');
            } else {
                card.classList.add('collapsed');
            }
        });
    });
}

// ============= AUTO-SELECT FIRST OPTIONS =============
function autoSelectFirstOptions() {
    // Auto-select mnq_strategy if available, otherwise first strategy
    const strategySelect = document.getElementById('strategy');
    if (strategySelect && strategySelect.options.length > 0) {
        const mnqOption = Array.from(strategySelect.options).find(opt => opt.value === 'mnq_strategy');
        if (mnqOption) {
            strategySelect.value = 'mnq_strategy';
        } else {
            strategySelect.selectedIndex = 0;
        }
    }
    
    // Auto-select first data file
    const dataSelect = document.getElementById('dataFile');
    if (dataSelect && dataSelect.options.length > 0) {
        dataSelect.selectedIndex = 0;
    }
    
    // Auto-select first score DB option (if available)
    const scoreSelect = document.getElementById('scoresFile');
    if (scoreSelect && scoreSelect.options.length > 1) {
        // Select first non-"None" option if available, otherwise keep "None"
        scoreSelect.selectedIndex = 1; // Index 0 is "None", 1 is first actual option
    }
}

// ============= FORM VALIDATION =============
function validateForm() {
    const form = document.getElementById('backtestForm');
    const isValid = form.checkValidity();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = !isValid;
}

// ============= FORM SUBMISSION =============
document.getElementById('backtestForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    const messageDiv = document.getElementById('resultMessage');
    submitBtn.disabled = true;

    const dataSelect = document.getElementById('dataFile');
    const scoresFileSelect = document.getElementById('scoresFile');
    const config = {
        data_file: dataSelect.value,
        strategy: document.getElementById('strategy').value,
        scores_file: scoresFileSelect ? (scoresFileSelect.value || null) : null,
        initial_capital: parseFloat(document.getElementById('initialCapital').value),
        commission: parseFloat(document.getElementById('commission').value),
        slippage_ticks: parseInt(document.getElementById('slippageTicks').value),
        max_bars_back: parseInt(document.getElementById('maxBarsBack').value),
        instrument_type: document.getElementById('instrumentType').value,
        point_value: parseFloat(document.getElementById('pointValue').value),
        tick_size: parseFloat(document.getElementById('tickSize').value)
    };

    try {
        const res = await fetch('/backtest/prepare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Failed to prepare');
        // Set flag to auto-open console on results page
        try {
            localStorage.setItem('autoOpenConsole', 'true');
        } catch (e) {}
        // Redirect immediately to the results page; it will stream and render
        window.location.href = `/results/temp/${data.temp_result_id}`;
    } catch (err) {
        messageDiv.style.display = 'block';
        messageDiv.textContent = `Failed to start backtest: ${err.message}`;
        submitBtn.disabled = false;
    }
});
</script>
<script>
// ============= INITIALIZATION =============
document.addEventListener('DOMContentLoaded', function() {
    autoSelectFirstOptions();
    initializeAccordions();
    validateForm();
    document.getElementById('tickSize').addEventListener('change', validateForm);
    document.getElementById('instrumentType').addEventListener('change', validateForm);
});
</script>
{% endblock %}
